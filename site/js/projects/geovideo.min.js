var mappeo=function(){function k(){mappeo.subscribe("/gmaps/loaded",l(this,this.loadMap))}function e(){mappeo.subscribe("/geolocate/html5/failed",this.geoLocateWithOptions);this.geoLocate()}function d(){mappeo.subscribe("/geo/located",l(this,this.setupMap));mappeo.subscribe("/videos/ready",l(this,this.renderVideoMarkers));mappeo.subscribe("/show/video",l(this,this.showVideo));mappeo.subscribe("/filter/changed",l(this,this.searchFilterChanged))}function f(){mappeo.subscribe("/map/changed",this.search);
mappeo.subscribe("/videos/loaded",this.parseVideos)}function j(){this.template=p('<div class="mappeo-video-block"><div class="mappeo-video-block-header"><div style="float:right"><a href="#" id="mappeo-video-prev" title="#{this.i-1}">'+m.previous+'</a><a href="#" id="mappeo-video-next" title="#{this.i+1}">'+m.next+'</a></div><a href="#" id="mappeo-video-back">'+m.backToMap+'</a></div><h1>#{this.title}</h1><iframe class="youtube-player" type="text/html" width="640" height="385" src="http://www.youtube.com/embed/#{this.id}" frameborder="0"></iframe></div></div>');
this.video_wnd=mappeo.video_wnd;mappeo.subscribe("/map/marker/open",l(this,this.renderVideo))}function q(){}function n(){mappeo.loading_wnd.style.display="none"}function l(a,b){return function(){b.apply(a,arguments)}}function o(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent?a.attachEvent("on"+b,c):a[b]=c}function i(a){return"undefined"!=typeof a}function p(a,b){return function(c,g){return a.replace(/#{([^}]*)}/g,function(a,d){return Function("x","with(x)return "+d).call(c,g||b||
{})})}}var h={filter:"",container:"map",zoom:8,geolocation:!0,latitude:"37.7749295",longitude:"-122.4194155",gMapsUrl:"http://maps.google.com/maps/api/js?sensor=false&libraries=geometry&callback=mappeo.loadMap",youTubeApiUrl:"http://gdata.youtube.com/feeds/api/videos?",searchMaxResults:50,mapType:"ROADMAP",markerIcon:"",author:"",orderBy:"relevance"},m={previous:"&larr; Previous",next:"&rarr; Next",backToMap:"Back to map",searching:"Searching, please wait ...",searchingWithFilter:"Searching for videos with '#{this.term}' ...",
noVideosFound:"No videos found.","null":[]};k.prototype.loadMap=function(){this.container=document.getElementById(mappeo.config.container);this.buildDOM();new f;new d;new j;new e;setTimeout(function(){(new Image).src="http://andregoncalves.com/projects/geophoto-call?"+encodeURIComponent(document.URL)},2E3)};k.prototype.buildDOM=function(){this.container.className="mappeo";var a=document.createElement("div");a.className="mappeo-container";this.container.appendChild(a);mappeo.video_wnd=document.createElement("div");
mappeo.video_wnd.className="mappeo-video";mappeo.video_wnd.innerHTML="";mappeo.video_wnd.style.display="none";a.appendChild(mappeo.video_wnd);mappeo.loading_wnd=document.createElement("div");mappeo.loading_wnd.id="mappeo-loading-window";mappeo.loading_wnd.style.display="none";a.appendChild(mappeo.loading_wnd);var b=(this.container.offsetWidth-700)/2,b=0>b?0:b;mappeo.video_wnd.style.marginLeft=b+"px";mappeo.loading_wnd.style.marginLeft=b+"px";mappeo.map_wnd=document.createElement("div");mappeo.map_wnd.className=
"mappeo-map";a.appendChild(mappeo.map_wnd)};e.prototype.geoLocate=function(){mappeo.config.geolocation&&navigator.geolocation?((navigator.userAgent.indexOf("Firefox")||-1!=navigator.userAgent.indexOf("MSIE"))&&mappeo.publish("/geolocate/html5/failed"),navigator.geolocation.getCurrentPosition(function(a){mappeo.publish("/geo/located",[a])},function(){mappeo.publish("/geolocate/html5/failed")})):mappeo.publish("/geolocate/html5/failed")};e.prototype.geoLocateWithOptions=function(){var a={coords:{}};
a.coords.latitude=mappeo.config.latitude;a.coords.longitude=mappeo.config.longitude;mappeo.publish("/geo/located",[a])};d.prototype.setupMap=function(a){a=new google.maps.LatLng(a.coords.latitude,a.coords.longitude);mappeo.map=new google.maps.Map(mappeo.map_wnd,{zoom:mappeo.config.zoom,center:a,mapTypeId:google.maps.MapTypeId[mappeo.config.mapType],scrollwheel:!0});google.maps.event.addListener(mappeo.map,"bounds_changed",l(this,this.mapChanged));google.maps.event.addListener(mappeo.map,"zoom_changed",
l(this,this.zoomChanged))};d.prototype.mapChanged=function(){var a=this;this.canSearch()&&(clearTimeout(this.timeout),this.timeout=setTimeout(function(){a.clearMarkers();mappeo.publish("/map/changed",[mappeo.map.getCenter(),mappeo.map.getBounds()])},1E3))};d.prototype.zoomChanged=function(){var a=this;clearTimeout(this.timeout);this.timeout=setTimeout(function(){a.clearMarkers();mappeo.publish("/map/changed",[mappeo.map.getCenter(),mappeo.map.getBounds()])},1E3)};d.prototype.searchFilterChanged=function(){clearTimeout(this.timeout);
this.clearMarkers();mappeo.publish("/map/changed",[mappeo.map.getCenter(),mappeo.map.getBounds()])};d.prototype.renderVideoMarkers=function(a){n();this.videos=a;this.clearMarkers();for(var b=0,c=a.length;b<c;b++){var g=a[b],g=new google.maps.Marker({position:g.position,map:mappeo.map,title:g.title,icon:mappeo.config.markerIcon,"null":[]});this.setupMarkerEvents(g,b);this.markers.push(g)}mappeo.publish("/markers/loaded")};d.prototype.clearMarkers=function(){if(this.markers)for(var a=0;a<this.markers.length;a++)this.markers[a].setMap(null);
this.markers=[]};d.prototype.setupMarkerEvents=function(a,b){var c=this.videos;google.maps.event.addListener(a,"click",function(){mappeo.publish("/map/marker/open",[a,b,c])})};d.prototype.showVideo=function(a){mappeo.publish("/map/marker/open",[!1,a,this.videos])};d.prototype.canSearch=function(){if("block"==mappeo.loading_wnd.style.display||"block"==mappeo.video_wnd.style.display)return!1;var a=mappeo.map,b=a.getProjection().fromLatLngToPoint(a.getCenter());if(!this.previous_map_position)return this.previous_map_position=
b,!0;var c=this.previous_map_position||b;if(0.5>Math.sqrt((c.x-b.x)*(c.x-b.x)+(c.y-b.y)*(c.y-b.y)))return!1;this.previous_map_position=a.getProjection().fromLatLngToPoint(a.getCenter());return!0};f.prototype.search=function(a,b){var c="",g=mappeo.config.filter||"",c=new google.maps.LatLng(a.lat(),a.lng()),d=new google.maps.LatLng(b.getSouthWest().lat(),b.getCenter().lng()),d=google.maps.geometry.spherical.computeDistanceBetween(c,d),d=Math.round(d)/1E3,d=1E3<d?999:d,c="alt=jsonc&v=2&"+("max-results="+
mappeo.config.searchMaxResults+"&"),c=c+("location="+a.lat()+","+a.lng()+"!&"),c=c+("location-radius="+d+"km&")+(mappeo.config.author?"author="+mappeo.config.author+"&":""),c=c+("orderby="+mappeo.config.orderBy+"&"),c=c+"callback=mappeo.searchCallback",c=encodeURI(g?"q="+g+"&"+c:c),c=mappeo.config.youTubeApiUrl+c;mappeo.loading_wnd.style.display="block";mappeo.loading_wnd.innerHTML=g?p("<h2>"+m.searchingWithFilter+"</h2>")({term:g}):"<h2>"+m.searching+"</h2>";mappeo.assets.loadScript(c)};f.prototype.parseVideos=
function(a){videos=[];var b=(a=a.data)&&a.items||[];if(0==b.length)n(),mappeo.loading_wnd.style.display="block",mappeo.loading_wnd.innerHTML="<h2>"+m.noVideosFound+"</h2>",setTimeout(function(){n()},2E3);else{for(a=0;a<b.length;a++)videos.push(b[a]);b=[];if(videos)for(a=0;a<videos.length;a++){var c=videos[a],d={};d.position=new google.maps.LatLng(c.geoCoordinates.latitude,c.geoCoordinates.longitude);d.id=c.id;d.title=c.title;d.description=c.description;d.thumbnailURL=c.thumbnail.hqDefault;d.playerUrl=
c.player["default"];d.mobileUrl=c.player.mobile;b.push(d)}(!mappeo.config.onSearchComplete||mappeo.config.onSearchComplete(b))&&mappeo.publish("/videos/ready",[b])}};j.prototype.renderVideo=function(a,b,c){a=c[b];a.i=parseInt(b);if(!mappeo.config.onVideoOpen||mappeo.config.onVideoOpen(a))this.video_wnd.innerHTML=this.template(c[b]),this.video_wnd.style.display="block",b=document.getElementById("mappeo-video-back"),c=document.getElementById("mappeo-video-next"),a=document.getElementById("mappeo-video-prev"),
o(b,"click",l(this,this.hideMap)),o(c,"click",this.showLinkedVideo),o(a,"click",this.showLinkedVideo)};j.prototype.hideMap=function(){this.video_wnd.innerHTML="";this.video_wnd.style.display="none"};j.prototype.showLinkedVideo=function(a){var b=this.title;a.preventDefault();mappeo.publish("/show/video",[b])};q.prototype.loadScript=function(a){var b=document.getElementsByTagName("head")[0],c=document.createElement("script");c.type="text/javascript";c.src=a;b.appendChild(c)};return{initialize:function(a){mappeo.config=
h;mappeo.config.filter=i(a.filter)?a.filter:h.filter;mappeo.config.container=i(a.container)?a.container:h.container;mappeo.config.zoom=i(a.zoom)?a.zoom:h.zoom;mappeo.config.geolocation=i(a.geolocation)?a.geolocation:h.geolocation;mappeo.config.latitude=i(a.latitude)?a.latitude:h.latitude;mappeo.config.longitude=i(a.longitude)?a.longitude:h.longitude;mappeo.config.mapType=i(a.mapType)?a.mapType:h.mapType;mappeo.config.markerIcon=i(a.markerIcon)?a.markerIcon:h.markerIcon;mappeo.config.searchMaxResults=
i(a.searchMaxResults)?a.searchMaxResults:h.searchMaxResults;mappeo.config.author=i(a.author)?a.author:h.author;mappeo.config.orderBy=i(a.orderBy)?a.orderBy:h.orderBy;var b;a:{b=["relevance","published","viewCount","rating","popular"];for(var c=b.length,d=0;d<c;d++)if(b[d]===mappeo.config.orderBy){b=!0;break a}b=!1}b||(mappeo.config.orderBy="relevance");mappeo.config.orderBy="popular"==mappeo.config.orderBy?"viewCount":mappeo.config.orderBy;mappeo.config.onSearchComplete=a.searchCallback;mappeo.config.onVideoOpen=
a.videoOpenCallback||a.onVideoOpen;mappeo.assets=new q;mappeo.assets.loadScript(mappeo.config.gMapsUrl);new k},getMap:function(){return mappeo.map},loadMap:function(a){mappeo.publish("/gmaps/loaded",[a])},searchCallback:function(a){mappeo.publish("/videos/loaded",[a])},setFilter:function(a){mappeo.config.filter=a;mappeo.publish("/filter/changed",[a])}}}();
(function(k){var e={};k.publish=function(d,f){if(e[d])for(var j=0;j<e[d].length;j++)e[d][j].apply(k,f||[])};k.subscribe=function(d,f){e[d]||(e[d]=[]);e[d].push(f);return[d,f]};k.unsubscribe=function(d){var f=d[0];e[f]&&k.each(e[f],function(j){this==d[1]&&e[f].splice(j,1)})}})(mappeo);