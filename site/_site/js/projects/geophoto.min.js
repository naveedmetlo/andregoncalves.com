var geoPhoto=function(){function m(){geoPhoto.subscribe("/gmaps/loaded",i(this,this.loadMap))}function e(){geoPhoto.subscribe("/geolocate/html5/failed",this.geoLocateWithOptions);this.geoLocate()}function d(){geoPhoto.subscribe("/geo/located",i(this,this.setupMap));geoPhoto.subscribe("/photos/ready",i(this,this.renderphotoMarkers));geoPhoto.subscribe("/show/photo",i(this,this.showPhoto));geoPhoto.subscribe("/filter/changed",i(this,this.searchFilterChanged))}function h(){geoPhoto.subscribe("/map/changed",
i(this,this.newSearch));geoPhoto.subscribe("/photos/loaded",i(this,this.parsePhotos));geoPhoto.subscribe("/albums/loaded",i(this,this.parseAlbums))}function l(){this.template=r('<div class="geoPhoto-photo-block"><div class="geoPhoto-photo-block-header"><div style="float:right"><a href="#" id="geoPhoto-photo-prev" title="#{this.i-1}">'+n.previous+'</a><a href="#" id="geoPhoto-photo-next" title="#{this.i+1}">'+n.next+'</a></div><a href="#" id="geoPhoto-photo-back">'+n.backToMap+'</a></div><div class="geoPhoto-view"><img src="#{this.thumbnail}" /></div><p><a href="#{this.url}" target="_blank">'+
n.openOriginal+"</a></p><h3>#{this.title}</h3></div></div>");this.photo_wnd=geoPhoto.photo_wnd;geoPhoto.subscribe("/map/marker/open",i(this,this.renderphoto))}function p(){}function o(){geoPhoto.loading_wnd.style.display="none"}function s(){geoPhoto.loading_wnd.style.display="block";geoPhoto.loading_wnd.innerHTML="<h2>"+n.noPhotosFound+"</h2>";setTimeout(function(){o()},2E3)}function i(a,b){return function(){b.apply(a,arguments)}}function q(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent?
a.attachEvent("on"+b,c):a[b]=c}function j(a){return"undefined"!=typeof a}function r(a,b){return function(c,f){return a.replace(/#{([^}]*)}/g,function(a,d){return Function("x","with(x)return "+d).call(c,f||b||{})})}}var k={filter:"",container:"map",zoom:12,geolocation:!0,latitude:"37.7749295",longitude:"-122.4194155",gMapsUrl:"http://maps.google.com/maps/api/js?sensor=false&libraries=geometry&callback=geoPhoto.loadMap",apiUrl:"http://photos.googleapis.com/data/feed/api/all",picasaApiUrl:"http://photos.googleapis.com/data/feed/api/all",
userApiUrl:"http://photos.googleapis.com/data/feed/api/user/",albumApiUrl:"http://picasaweb.google.com/data/feed/api/user/",searchMaxResults:100,mapType:"ROADMAP",markerIcon:"",author:"",orderBy:"relevance",albums:!1,"null":[]},n={previous:"&lArr; Previous",next:"Next &rArr;",backToMap:"Back to map",searching:"Searching, please wait ...",searchingWithFilter:"Searching for photos with '#{this.term}' ...",noPhotosFound:"No Photos found.",openOriginal:"Open original","null":[]};m.prototype.loadMap=function(){this.container=
document.getElementById(geoPhoto.config.container);this.buildDOM();new h;new d;new l;new e};m.prototype.buildDOM=function(){this.container.className="geoPhoto";var a=document.createElement("div");a.className="geoPhoto-container";this.container.appendChild(a);geoPhoto.photo_wnd=document.createElement("div");geoPhoto.photo_wnd.className="geoPhoto-photo";geoPhoto.photo_wnd.innerHTML="";geoPhoto.photo_wnd.style.display="none";a.appendChild(geoPhoto.photo_wnd);geoPhoto.loading_wnd=document.createElement("div");
geoPhoto.loading_wnd.id="geoPhoto-loading-window";geoPhoto.loading_wnd.style.display="none";a.appendChild(geoPhoto.loading_wnd);var b=(this.container.offsetWidth-450)/2;geoPhoto.photo_wnd.style.marginLeft=(0>b?0:b)+"px";b=(this.container.offsetWidth-700)/2;geoPhoto.loading_wnd.style.marginLeft=(0>b?0:b)+"px";geoPhoto.map_wnd=document.createElement("div");geoPhoto.map_wnd.className="geoPhoto-map";a.appendChild(geoPhoto.map_wnd)};e.prototype.geoLocate=function(){geoPhoto.config.geolocation&&navigator.geolocation?
((navigator.userAgent.indexOf("Firefox")||-1!=navigator.userAgent.indexOf("MSIE"))&&geoPhoto.publish("/geolocate/html5/failed"),navigator.geolocation.getCurrentPosition(function(a){geoPhoto.publish("/geo/located",[a])},function(){geoPhoto.publish("/geolocate/html5/failed")})):geoPhoto.publish("/geolocate/html5/failed")};e.prototype.geoLocateWithOptions=function(){var a={coords:{}};a.coords.latitude=geoPhoto.config.latitude;a.coords.longitude=geoPhoto.config.longitude;geoPhoto.publish("/geo/located",
[a])};e.prototype.geocode=function(){};d.prototype.setupMap=function(a){a=new google.maps.LatLng(a.coords.latitude,a.coords.longitude);geoPhoto.map=new google.maps.Map(geoPhoto.map_wnd,{zoom:geoPhoto.config.zoom,center:a,mapTypeId:google.maps.MapTypeId[geoPhoto.config.mapType],scrollwheel:!0});google.maps.event.addListener(geoPhoto.map,"bounds_changed",i(this,this.mapChanged));google.maps.event.addListener(geoPhoto.map,"zoom_changed",i(this,this.zoomChanged))};d.prototype.mapChanged=function(){var a=
this;this.canSearch()&&(clearTimeout(this.timeout),this.timeout=setTimeout(function(){a.clearMarkers();geoPhoto.publish("/map/changed",[geoPhoto.map.getCenter(),geoPhoto.map.getBounds()])},1E3))};d.prototype.zoomChanged=function(){var a=this;clearTimeout(this.timeout);this.timeout=setTimeout(function(){a.clearMarkers();geoPhoto.publish("/map/changed",[geoPhoto.map.getCenter(),geoPhoto.map.getBounds()])},1E3)};d.prototype.searchFilterChanged=function(){clearTimeout(this.timeout);this.clearMarkers();
geoPhoto.publish("/map/changed",[geoPhoto.map.getCenter(),geoPhoto.map.getBounds()])};d.prototype.renderphotoMarkers=function(a){o();this.photos=a;this.clearMarkers();for(var b=0,c=a.length;b<c;b++){var f=a[b],f=new google.maps.Marker({position:f.position,map:geoPhoto.map,title:f.text,icon:geoPhoto.config.markerIcon,"null":[]});this.setupMarkerEvents(f,b);this.markers.push(f)}geoPhoto.publish("/markers/loaded")};d.prototype.clearMarkers=function(){if(this.markers)for(var a=0;a<this.markers.length;a++)this.markers[a].setMap(null);
this.markers=[]};d.prototype.setupMarkerEvents=function(a,b){var c=this.photos;google.maps.event.addListener(a,"click",function(){geoPhoto.publish("/map/marker/open",[a,b,c])})};d.prototype.showPhoto=function(a){geoPhoto.publish("/map/marker/open",[!1,a,this.photos])};d.prototype.canSearch=function(){if("block"==geoPhoto.loading_wnd.style.display)return!1;var a=geoPhoto.map,b=a.getProjection().fromLatLngToPoint(a.getCenter());if(!this.previous_map_position)return this.previous_map_position=b,!0;var c=
this.previous_map_position||b;if(0.5>Math.sqrt((c.x-b.x)*(c.x-b.x)+(c.y-b.y)*(c.y-b.y)))return!1;this.previous_map_position=a.getProjection().fromLatLngToPoint(a.getCenter());return!0};h.prototype.newSearch=function(a,b){geoPhoto.photos=[];this.search(a,b,1)};h.prototype.search=function(a,b,c){this.page=c;var f="",d=geoPhoto.config.filter||"",f=new google.maps.LatLng(a.lat(),a.lng()),g=new google.maps.LatLng(b.getSouthWest().lat(),b.getCenter().lng()),a=b.getSouthWest().lng()+","+b.getSouthWest().lat()+
",",a=a+(b.getNorthEast().lng()+","+b.getNorthEast().lat()),b=google.maps.geometry.spherical.computeDistanceBetween(f,g);Math.round(b);f=geoPhoto.config.albums?"alt=json-in-script&kind=album&thumbsize=400u&callback=geoPhoto.albumsCallback":"alt=json-in-script&kind=photo&thumbsize=400u&callback=geoPhoto.searchCallback";f+="&max-results="+geoPhoto.config.searchMaxResults+"&";f=f+("&bbox="+a)+("&page="+c);f=encodeURI(d?"q="+d+"&"+f:f);c=geoPhoto.config.apiUrl+"?"+f;geoPhoto.loading_wnd.style.display=
"block";geoPhoto.loading_wnd.innerHTML=d?r("<h2>"+n.searchingWithFilter+"</h2>")({term:d}):"<h2>"+n.searching+"</h2>";geoPhoto.assets.loadScript(c)};h.prototype.parsePhotos=function(a){var b=geoPhoto.photos,c=(a=a&&a.feed)&&a.entry||[],a=[],f=0;if(0==c.length)o(),s();else{for(var f=c.length,d=0;d<f;d++)b.push(c[d]);if(f=b.length)for(d=0;d<f;d++){var c=b[d],g={};if(c.georss$where){var e=c.georss$where.gml$Point.gml$pos.$t,e=e.split(" ");g.position=new google.maps.LatLng(e[0],e[1]);g.id=c.gphoto$id.$t;
g.title=c.title.$t;g.url=c.content.src;g.type=c.content.type;g.author=c.author?c.author[0].name.$t:"";g.width=c.gphoto$width.$t;g.height=c.gphoto$height.$t;g.thumbnail=c.media$group.media$thumbnail[0].url;a.push(g)}}(!geoPhoto.config.onSearchComplete||geoPhoto.config.onSearchComplete(a))&&geoPhoto.publish("/photos/ready",[a])}};h.prototype.parseAlbums=function(a){var b=geoPhoto.photos,c=(a=a&&a.feed)&&a.entry||[],a=[],d=0;if(0==c.length)o(),s();else{for(var d=c.length,e=0;e<d;e++)b.push(c[e]);if(d=
b.length)for(e=0;e<d;e++){var c=b[e],g={};if(c.georss$where){var h=c.georss$where.gml$Point.gml$pos.$t,h=h.split(" ");g.position=new google.maps.LatLng(h[0],h[1]);g.id=c.gphoto$id.$t;g.title=c.title.$t;g.url=c.link[1];g.type="album";g.totalPhotos=c.gphoto$numphotos.$t;a.push(g)}}(!geoPhoto.config.onSearchComplete||geoPhoto.config.onSearchComplete(a))&&geoPhoto.publish("/photos/ready",[a])}};l.prototype.renderphoto=function(a,b,c){a=c[b];0>b?b=c.length-1:a||(b=0);a=c[b];a.i=parseInt(b);if(!geoPhoto.config.onPhotoOpen||
geoPhoto.config.onPhotoOpen(a))"album"==a.type?window.location=a.url.href:(this.photo_wnd.innerHTML=this.template(c[b]),this.photo_wnd.style.display="block",b=document.getElementById("geoPhoto-photo-back"),c=document.getElementById("geoPhoto-photo-next"),a=document.getElementById("geoPhoto-photo-prev"),q(b,"click",i(this,this.hideMap)),q(c,"click",this.showLinkedPhoto),q(a,"click",this.showLinkedPhoto))};l.prototype.renderAlbum=function(a,b,c){console.info(c[b])};l.prototype.hideMap=function(){this.photo_wnd.innerHTML=
"";this.photo_wnd.style.display="none"};l.prototype.showLinkedPhoto=function(a){var b=this.title;a.preventDefault();geoPhoto.publish("/show/photo",[b])};p.prototype.loadScript=function(a){var b=document.getElementsByTagName("head")[0],c=document.createElement("script");c.type="text/javascript";c.src=a;b.appendChild(c)};p.prototype.loadJSON=function(a){var b=document.getElementsByTagName("head")[0],c=document.createElement("script");c.type="application/json";c.src=a;b.appendChild(c)};return{initialize:function(a){this.config=
k;this.config.filter=j(a.filter)?a.filter:k.filter;this.config.container=j(a.container)?a.container:k.container;this.config.zoom=j(a.zoom)?a.zoom:k.zoom;this.config.geolocation=j(a.geolocation)?a.geolocation:k.geolocation;this.config.latitude=j(a.latitude)?a.latitude:k.latitude;this.config.longitude=j(a.longitude)?a.longitude:k.longitude;this.config.mapType=j(a.mapType)?a.mapType:k.mapType;this.config.markerIcon=j(a.markerIcon)?a.markerIcon:k.markerIcon;this.config.searchMaxResults=j(a.searchMaxResults)?
a.searchMaxResults:k.searchMaxResults;this.config.author=j(a.author)?a.author:k.author;this.config.albums=j(a.albums)?a.albums&&this.config.author:!1;this.config.apiUrl=this.config.picasaApiUrl;this.config.apiUrl=this.config.author?this.config.userApiUrl+this.config.author:this.config.apiUrl;this.config.apiUrl=this.config.albums?this.config.albumApiUrl+this.config.author:this.config.apiUrl;this.config.orderBy=j(a.orderBy)?a.orderBy:k.orderBy;var b;a:{b=["relevance","published","viewCount","rating",
"popular"];for(var c=b.length,d=0;d<c;d++)if(b[d]===this.config.orderBy){b=!0;break a}b=!1}b||(this.config.orderBy="relevance");this.config.orderBy="popular"==this.config.orderBy?"viewCount":this.config.orderBy;this.config.onSearchComplete=a.searchCallback||!1;this.config.onPhotoOpen=a.photoOpenCallback||!1;this.assets=new p;this.assets.loadScript(this.config.gMapsUrl);new m},getMap:function(){return geoPhoto.map},loadMap:function(a){geoPhoto.publish("/gmaps/loaded",[a])},searchCallback:function(a){geoPhoto.publish("/photos/loaded",
[a])},albumsCallback:function(a){geoPhoto.publish("/albums/loaded",[a])},setFilter:function(a){geoPhoto.config.filter=a;geoPhoto.publish("/filter/changed",[a])}}}();(function(m){var e={};m.publish=function(d,h){if(e[d])for(var l=0;l<e[d].length;l++)e[d][l].apply(m,h||[])};m.subscribe=function(d,h){e[d]||(e[d]=[]);e[d].push(h);return[d,h]};m.unsubscribe=function(d){var h=d[0];e[h]&&m.each(e[h],function(l){this==d[1]&&e[h].splice(l,1)})}})(geoPhoto);